qdata0   .req q8
qdata1   .req q9
qdata2   .req q10
qdata3   .req q11

qtwiddle .req q0
qmodulus .req q1

data0    .req v8
data1    .req v9
data2    .req v10
data3    .req v11

twiddle  .req v0
modulus  .req v1

tmp      .req v12

data_ptr      .req x0
twiddle_ptr   .req x1
modulus_ptr   .req x2

.macro barmul out, in, twiddle, modulus
    mul      \out.8h,   \in.8h, \twiddle.h[0]
    sqrdmulh \in.8h,    \in.8h, \twiddle.h[1]
    mls      \out.8h,   \in.8h, \modulus.h[0]
.endm

.macro butterfly data0, data1, tmp, twiddle, modulus
    barmul \tmp, \data1, \twiddle, \modulus
    sub    \data1.8h, \data0.8h, \tmp.8h
    add    \data0.8h, \data0.8h, \tmp.8h
.endm

count .req x2
    ldr qtwiddle, [twiddle_ptr, #0]
    ldr qmodulus, [modulus_ptr, #0]
        ldr q10, [x0, #48]                      // .*....
        ldr q13, [x0, #16]                      // *.....
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        sqrdmulh v6.8H, v13.8H, v0.H[1]         // ..*...
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        mul v8.8H, v13.8H, v0.H[0]              // ...*..
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        sqrdmulh v12.8H, v10.8H, v0.H[1]        // ....*.
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        // gap                                  // ......
        mls v8.8H, v6.8H, v1.H[0]               // .....*
        // gap                                  // ......
        // gap                                  // ......

        // original source code
        // ldr q9, [x0, #16]                     // .*....
        // ldr q10, [x0, #48]                    // *.....
        // sqrdmulh v7.8H, v9.8H, v0.H[1]        // ..*...
        // mul v8.8H, v9.8H, v0.H[0]             // ...*..
        // sqrdmulh v12.8H, v10.8H, v0.H[1]      // ....*.
        // mls v8.8H, v7.8H, v1.H[0]             // .....*

        sub count, count, #1
start:
        ldr q23, [x0, #0]                       // *.................
        ldr q9, [x0, #80]                       // .e................
        mul v31.8H, v10.8H, v0.H[0]             // .........*........
        ldr q19, [x0, #32]                      // ..*...............
        ldr q10, [x0, #112]                     // ...e..............
        // gap                                  // ..................
        // gap                                  // ..................
        // gap                                  // ..................
        mls v31.8H, v12.8H, v1.H[0]             // ...........*......
        // gap                                  // ..................
        // gap                                  // ..................
        // gap                                  // ..................
        sqrdmulh v7.8H, v9.8H, v0.H[1]          // .....e............
        // gap                                  // ..................
        add v30.8H, v23.8H, v8.8H               // ........*.........
        sub v18.8H, v23.8H, v8.8H               // .......*..........
        // gap                                  // ..................
        // gap                                  // ..................
        mul v8.8H, v9.8H, v0.H[0]               // ....e.............
        // gap                                  // ..................
        // gap                                  // ..................
        sub v23.8H, v19.8H, v31.8H              // ............*.....
        // gap                                  // ..................
        // gap                                  // ..................
        sqrdmulh v12.8H, v10.8H, v0.H[1]        // ..........e.......
        add v28.8H, v19.8H, v31.8H              // .............*....
        // gap                                  // ..................
        // gap                                  // ..................
        // gap                                  // ..................
        str q18, [x0, #16]                      // ...............*..
        mls v8.8H, v7.8H, v1.H[0]               // ......e...........
        str q23, [x0, #48]                      // .................*
        str q30, [x0], #4*16                    // ..............*...
        str q28, [x0, #-32]                     // ................*.
        // gap                                  // ..................
        // gap                                  // ..................

        // original source code
        // ldr q8, [x0, #0*16]                      // .................*.................
        // ldr q9, [x0, #1*16]                      // e................|e................
        // ldr q10, [x0, #2*16]                     // ..*..............|..*..............
        // ldr q11, [x0, #3*16]                     // ...e.............|...e.............
        // mul      v12.8h,   v9.8h, v0.h[0]        // ........e........|........e........
        // sqrdmulh v9.8h,    v9.8h, v0.h[1]        // .....e...........|.....e...........
        // mls      v12.8h,   v9.8h, v1.h[0]        // .............e...|.............e...
        // sub    v9.8h, v8.8h, v12.8h              // .......*.........|.......*.........
        // add    v8.8h, v8.8h, v12.8h              // ......*..........|......*..........
        // mul      v12.8h,   v11.8h, v0.h[0]       // .*...............|.*...............
        // sqrdmulh v11.8h,    v11.8h, v0.h[1]      // ..........e......|..........e......
        // mls      v12.8h,   v11.8h, v1.h[0]       // ....*............|....*............
        // sub    v11.8h, v10.8h, v12.8h            // .........*.......|.........*.......
        // add    v10.8h, v10.8h, v12.8h            // ...........*.....|...........*.....
        // str q8, [x0], #4*16                      // ...............*.|...............*.
        // str q9, [x0, #-3*16]                     // ............*....|............*....
        // str q10, [x0, #-2*16]                    // ................*|................*
        // str q11, [x0, #-1*16]                    // ..............*..|..............*..

        sub count, count, #1
        cbnz count, start
        ldr q23, [x0, #0]                  // *...........
        mul v31.8H, v10.8H, v0.H[0]        // .*..........
        ldr q9, [x0, #32]                  // ..*.........
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        mls v31.8H, v12.8H, v1.H[0]        // ...*........
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        sub v1.8H, v23.8H, v8.8H           // .....*......
        add v23.8H, v23.8H, v8.8H          // ....*.......
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        sub v0.8H, v9.8H, v31.8H           // ......*.....
        add v31.8H, v9.8H, v31.8H          // .......*....
        str q1, [x0, #16]                  // ........*...
        str q23, [x0], #4*16               // ..........*.
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        // gap                             // ............
        str q0, [x0, #-16]                 // .........*..
        str q31, [x0, #-32]                // ...........*
        // gap                             // ............

        // original source code
        // ldr q23, [x0, #0]                // *...........
        // mul v31.8H, v10.8H, v0.H[0]      // .*..........
        // ldr q19, [x0, #32]               // ..*.........
        // mls v31.8H, v12.8H, v1.H[0]      // ...*........
        // add v30.8H, v23.8H, v8.8H        // .....*......
        // sub v18.8H, v23.8H, v8.8H        // ....*.......
        // sub v23.8H, v19.8H, v31.8H       // ......*.....
        // add v28.8H, v19.8H, v31.8H       // .......*....
        // str q18, [x0, #16]               // ........*...
        // str q23, [x0, #48]               // ..........*.
        // str q30, [x0], #4*16             // .........*..
        // str q28, [x0, #-32]              // ...........*
